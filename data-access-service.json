{
    "kind": "Template",
    "apiVersion": "v1",
    "metadata": {
    	"name": "data-access-service",
        "annotations": {
            "iconClass": "icon-datavirt",            
            "description": "Data Access Service, integrate data from multiple disparate data sources.",
            "tags": "datavirt,jdv,data,virtualization,integration",
            "version": "1.0.0",
            "openshift.io/display-name": "Data Access Service",
	        "template.openshift.io/documentation-url": "http://teiid.org/docs/",
	        "template.openshift.io/long-description": "This template provides UI to create a data access services using Teiid Data Virtualization Technology. Combine data from disparte hetrogeneous sources like files, relational databases, cloud sources, webservices etc and expose them as single service",
	        "template.openshift.io/provider-display-name": "Red Hat, Inc.",
	        "template.openshift.io/support-url": "http://teiid.org/"       
        }
    },
    "labels": {
        "template": "data-access-service"
    },
    "message": "A new data access service has been created in your project",
    "parameters": [
        {
            "description": "Namespace for the application. Note: The namespace is required for creating proper RoleBindings. Specifying wrong namespace will prevent cluster from forming. This sould be same as your project name.",
            "name": "NAMESPACE",
            "required": true,
            "value": "myproject"
        }
    ],    
    "objects": [
    {
      "apiVersion": "v1",
      "kind": "ServiceAccount",
      "metadata": {
        "name": "proxy",
        "annotations": {
          "serviceaccounts.openshift.io/oauth-redirectreference.primary": "{\"kind\":\"OAuthRedirectReference\",\"apiVersion\":\"v1\",\"reference\":{\"kind\":\"Route\",\"name\":\"proxy\"}}"
        }
      }
    },
    {
      "apiVersion": "route.openshift.io/v1",
      "kind": "Route",
      "metadata": {
        "name": "proxy"
      },
      "spec": {
        "port": {
            "targetPort": 8443
         },
        "to": {
          "name": "proxy",
          "kind": "Service"
        },
        "tls": {
          "termination": "Reencrypt"
        }
      }
    },   
    {
      "apiVersion": "v1",
      "kind": "Service",
      "metadata": {
        "name": "proxy",
        "annotations": {
          "service.alpha.openshift.io/serving-cert-secret-name": "proxy-tls"
        }
      },
      "spec": {
        "ports": [
          {
            "name": "proxy",
            "port": 443,
            "targetPort": 8443
          }
        ],
        "selector": {
          "app": "proxy"
        }
      }
    },
    {
      "apiVersion": "extensions/v1beta1",
      "kind": "Deployment",
      "metadata": {
        "name": "proxy"
      },
      "spec": {
        "replicas": 1,
        "selector": {
          "matchLabels": {
            "app": "proxy"
          }
        },
        "template": {
          "metadata": {
            "labels": {
              "app": "proxy"
            }
          },
          "spec": {
            "serviceAccountName": "proxy",
            "containers": [
              {
                "name": "oauth-proxy",
                "image": "openshift/oauth-proxy:v1.0.0",
                "imagePullPolicy": "IfNotPresent",
                "ports": [
                  {
                    "containerPort": 8443,
                    "name": "public"
                  }
                ],
                "args": [
                  "--https-address=:8443",
                  "--provider=openshift",
                  "--openshift-service-account=proxy",
                  "--upstream=http://komodo:8080/vdb-builder/",
                  "--tls-cert=/etc/tls/private/tls.crt",
                  "--tls-key=/etc/tls/private/tls.key",
                  "--cookie-secret=V2lsZDAwZDJXaWxkMDBkMg==",
                  "--pass-access-token=true",
                  "--skip-provider-button=true",
                  "--pass-basic-auth=true",
                  "--pass-user-headers=true",
                  "--pass-host-header=true",
                  "--skip-auth-preflight",
                  "--openshift-ca=/etc/pki/tls/certs/ca-bundle.crt",
                  "--openshift-ca=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt",
                  "--scope=user:info user:check-access role:admin:${NAMESPACE}:! role:cluster-admin:${NAMESPACE}:!"
                ],
                "volumeMounts": [
                  {
                    "mountPath": "/etc/tls/private",
                    "name": "proxy-tls"
                  }
                ]
              }
            ],
            "volumes": [
              {
                "name": "proxy-tls",
                "secret": {
                  "secretName": "proxy-tls"
                }
              }
            ]
          }
        }
      }
    },   
    {
      "apiVersion": "v1",
      "kind": "Route",
      "metadata": {
        "name": "komodo"
      },
      "spec": {    
        "port": {
            "targetPort": 8080
         },
        "to": {
          "name": "komodo",
          "kind": "Service"          
        }
      }
    },     
    {
        "kind": "Service",
        "apiVersion": "v1",
        "metadata": {
            "name": "komodo",
            "labels": {
                "application": "komodo"
            },
            "annotations": {
                "description": "Route for Data Virtualization services."
            }
        },
        "spec": {
            "ports": [
                {
                    "name": "http",
                    "port": 8080,
                    "targetPort": 8080
                },
                {
                    "name": "admin",
                    "port": 9990,
                    "targetPort": 9990
                }
            ],
            "selector": {
                "name": "komodo"
            }
        }
    },
	{
       "apiVersion": "v1",
       "kind": "DeploymentConfig",
	   "metadata":{
	      "name":"komodo"
	   },
	   "spec":{
	      "replicas":1,
	      "selector": {
	      	"name": "komodo" 
	      },
	      "strategy":{
	          "type": "Recreate"
	      },	      	   
	      "template":{
	         "metadata":{
	            "labels":{
	               "name":"komodo"
	            }
	         },
	         "spec":{
	            "serviceAccountName": "proxy",
	            "terminationGracePeriodSeconds":120,
	            "containers":[
	               {
	                  "capabilities": {},
	                  "name":"komodo",
	                  "image":" ",
	                  "imagePullPolicy":"IfNotPresent",                 
	                  "ports":[                  
	                     {
	                        "name":"http",
	                        "containerPort":8080,
	                        "protocol":"TCP"
	                     },
	                     {
	                        "name":"admin",
	                        "containerPort":9990,
	                        "protocol":"TCP"
	                     }
	                  ],
	                  "env":[
	                     {
	                        "name":"OPENSHIFT_KUBE_PING_LABELS",
	                        "value":"application=komodo"
	                     },
	                     {
	                        "name":"OPENSHIFT_KUBE_PING_NAMESPACE",
	                        "valueFrom":{
	                           "fieldRef":{
	                              "fieldPath":"metadata.namespace"
	                           }
	                        }
	                     },
	                     {
	                        "name":"GC_MAX_METASPACE_SIZE",
	                        "value":"512"
	                     },
	                     {
	                        "name": "NAMESPACE",
	                        "valueFrom":{
	                           "fieldRef":{
	                              "fieldPath":"metadata.namespace"
	                           }
	                        }
	                     },
	                     {
	                     	"name": "JAVA_OPTIONS",
	                     	"value": "-DNAMESPACE=${NAMESPACE} -Djava.net.preferIPv4Stack=true -Djava.net.preferIPv4Addresses=true -Dlog4j.logger.org.apache.http=DEBUG"
	                     }                                          
	                  ]
	               }
	            ]
	         }
	      },
	      "triggers": [
			{
			    "imageChangeParams": {
			        "automatic": true,
			        "containerNames": [
			            "komodo"
			        ],
			        "from": {
			            "kind": "ImageStreamTag",
			            "name": "komodo:latest",
			            "namespace": "openshift"
			        },
			        "lastTriggeredImage": ""
			    },
			    "type": "ImageChange"
			},
			{
			    "type": "ConfigChange"
			}
	      ]	      
	   }
	}        
  ]
}
